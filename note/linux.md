## 网络
### Netfilter
参考：[你知道吗？Linux中的iptables到底是什么？netfilter又是什么？ 白话iptables工作原理 ｜097](https://www.bilibili.com/video/BV1qNKcz8Eb1/?spm_id_from=333.337.search-card.all.click)

**核心**：五链四表。

**五链**: Linux Netfilter中的 `prerouting`, `input`, `forward, output`, 和 `postrouting` 链。作用在网络层和传输层。

**四表**: `filter`, `nat`, `mangle`, 和 `raw` 表。每个表包含多个链。

#### 五链

**PREROUTING**
- 作用层级: 网络层 (Layer 3) 和 传输层 (Layer 4)。
- 触发时机: 当一个数据包从任何网络接口进入系统时，在内核进行路由决策（即判断数据包是发往本机还是需要转发）之前，会立即经过此链。
- 主要用途:
目标网络地址转换 (DNAT): 这是PREROUTING最常见的用途。例如，将访问防火墙公网IP:80的数据包，修改其目标地址为内网某台Web服务器的IP:8080。这个修改IP地址的操作是典型的Layer 3行为，而修改端口号是Layer 4行为。
原始包过滤: 在路由前对数据包进行标记或过滤。

**INPUT**
- 作用层级: 网络层 (Layer 3) 和 传输层 (Layer 4)。
- 触发时机: 在经过PREROUTING链和路由决策后，如果内核确认该数据包的目标是本机（即发往本机上运行的某个应用程序），数据包就会进入INPUT链。
- 主要用途:
保护本机服务: 这是最核心的防火墙功能。控制哪些外部IP地址可以访问本机的哪些端口。例如，只允许特定IP访问SSH的22端口。这同时利用了Layer 3（源IP）和Layer 4（目标端口）的信息。

**FORWARD**
- 作用层级: 网络层 (Layer 3) 和 传输层 (Layer 4)。
- 触发时机: 在经过PREROUTING链和路由决策后，如果内核确认该数据包的目标不是本机，而是需要经由本机转发到另一个网络接口，数据包就会进入FORWARD链。
- 主要用途:
实现路由转发过滤: 当Linux主机作为路由器或网关时，FORWARD链用于过滤流经它的数据包。例如，控制内网用户可以访问外网的哪些服务，或者阻止某些外部流量进入内网。这同样是基于Layer 3（源/目标IP）和Layer 4（端口、协议）的策略。

**OUTPUT**
- 作用层级: 网络层 (Layer 3) 和 传输层 (Layer 4)。
- 触发时机: 当本机上运行的任何应用程序生成一个数据包并向外发送时，该数据包在进行路由决策之前会经过OUTPUT链。
- 主要用途:
控制本机对外访问: 限制本机应用程序向外发起连接。例如，禁止服务器主动连接外部的某个恶意IP地址，或者只允许root用户访问外网。
本地流量重定向: 可以对本地产生的流量进行DNAT，虽然这种用法不常见。

**POSTROUTING**
- 作用层级: 网络层 (Layer 3) 和 传输层 (Layer 4)。
- 触发时机: 当任何一个准备离开本机的数据包（无论是本机产生的还是转发的）在即将被发送到网络接口之前，会经过此链。这是数据包离开内核前的最后一站。
- 主要用途:
源网络地址转换 (SNAT/MASQUERADE): 这是POSTROUTING最核心的用途。例如，将所有来自内网的数据包的源IP地址，修改为防火墙的公网IP地址，从而实现内网共享上网。修改源IP地址是典型的Layer 3操作。


**以下是gemini对netfilter的链表和内核网络层次的流程描述**：
我们以两种最典型的数据包为例来走一遍这个流程。

场景一：外部数据包进入，目标是本机服务 (例如访问本机的Web服务器)
进入内核 (L1/L2 -> L3)

数据包从物理网络通过**网络接口(NIC)**进入内核。
内核驱动程序处理数据链路层（L2，如以太网）的头部，剥离后将IP数据包（L3）向上传递给网络层。
安检站 1: PREROUTING 链

位置: 网络层，路由决策之前。
工作: 这是数据包进入内核网络层后遇到的第一个Netfilter链。此时内核只知道数据包来了，还未决定要拿它怎么办。
典型操作: DNAT (目标地址转换)。例如，如果这个包的目的IP是防火墙的公网IP，端口是80，PREROUTING链的规则可以将目标IP和端口修改为内网一台Web服务器的私有IP和8080端口。
路由决策 (Routing Decision)

工作: 内核检查数据包的目标IP地址。
判断: "这个IP是我自己的吗？" 在这个场景中，答案是“是”（即使经过了DNAT，目标IP也被改成了本机或本机可达的地址）。因此，内核决定将数据包发往“本地投递”路径。
安检站 2: INPUT 链

位置: 网络层/传输层，数据包即将被本地应用程序接收之前。
工作: 这是保护本机服务的核心关卡。
典型操作: 防火墙过滤。例如，INPUT链的规则会检查源IP、目标端口（L4的TCP 80端口）等信息，判断是否允许这个连接。如果规则是ACCEPT，则放行；如果是DROP或REJECT，则数据包在此被丢弃，无法到达应用程序。
到达应用程序 (L4 -> L7)

如果数据包通过了INPUT链，它将被传递到传输层（L4），内核根据端口号找到正在监听的应用程序（如Apache、Nginx），数据包最终被应用程序接收和处理。
场景二：外部数据包进入，需要本机进行转发 (本机作为路由器)
进入内核 & PREROUTING 链: 与场景一的步骤1和2完全相同。数据包进入内核，首先经过PREROUTING链。

路由决策 (Routing Decision)

工作: 内核检查数据包的目标IP地址。
判断: "这个IP是我自己的吗？" 在这个场景中，答案是“否”。内核接着会查找路由表，判断是否知道如何将这个包转发到它的目的地。如果知道（例如，通过另一个网络接口），内核决定将数据包发往“转发”路径。
安检站 3: FORWARD 链

位置: 网络层/传输层，在两个网络接口之间传递数据包的路径上。
工作: 这是控制网络间流量的核心关卡。
典型操作: 转发过滤。例如，FORWARD链的规则可以规定“只允许内网访问外网的HTTP和HTTPS流量”，或者“禁止A网段访问B网段的任何服务”。不符合规则的数据包在此被丢弃。
安检站 4: POSTROUTING 链

位置: 网络层，数据包即将离开本机之前。
工作: 这是所有离开本机（无论是转发还是本机产生）的数据包的最后一站。
典型操作: SNAT (源地址转换) / MASQUERADE (地址伪装)。例如，为了让内网（私有IP）的电脑能上网，路由器（本机）在此处将数据包的源IP地址从内网私有IP修改为路由器的公网IP。
离开内核 (L3 -> L2/L1)

数据包通过POSTROUTING链后，被传递到相应出向网络接口的驱动，封装上L2头部，然后发送到物理网络。
场景三：本机应用程序主动向外发送数据包
数据包产生 (L7 -> L4 -> L3)

本机的一个应用程序（如curl或浏览器）创建数据，经由传输层（L4）封装成TCP/UDP段，再由网络层（L3）封装成IP数据包。
安检站 5: OUTPUT 链

位置: 网络层/传输层，本机产生的包在路由之前。
工作: 控制本机发出的流量。
典型操作: 出站过滤。例如，可以设置规则“禁止本机访问某个特定的外部IP”，或者“只允许root用户产生的流量出站”。
路由决策 (Routing Decision)

内核查找路由表，确定该从哪个网络接口把这个包发出去。
POSTROUTING 链: 与场景二的步骤4相同。数据包在离开前经过此链，可能会被执行SNAT操作。

离开内核: 与场景二的步骤5相同。数据包被发送出去。

总结
入口统一: 所有进来的包都先经过 PREROUTING。
决策分流: 路由决策是第一个分叉口，决定包是去 INPUT (给自己的) 还是 FORWARD (给别人的)。
出口统一: 所有出去的包（本机产生的或转发的）都最后经过 POSTROUTING。
内外有别: INPUT 和 OUTPUT 链处理与本机直接相关的流量，而 FORWARD 链处理与本机无关、只是流经本机的流量。


### 内核网络数据包的接收流程
